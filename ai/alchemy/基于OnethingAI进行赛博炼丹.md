
## 导语
> 不念过去，不畏将来，只争朝夕，不负韶华！

---

## 简介

在上一个章节，我已经教过大家如何打造自己的丹炉，现在，我们继续。接下来，我会带领大家使用丹炉炼出我们的第一炉丹。

你可以选择继续使用上一个章节自己打造出的丹炉，亦或者像我现在一样，使用平台提供给我们的丹炉。

## 环境选择

下面就我为这次打造的赛博炼丹选择的炼丹炉以及炼丹室，大家可以参考一下：

+ 丹室 (使用平台) [OnethingAI](https://onethingai.com/)
+ 丹炉 (使用镜像) Ubuntu(22.04)/SD-LoRA训练-炼丹炉LoRA-scripts:v0.1.3
+ 丹火 (使用显卡) NVIDIA-GEFORCE-RTX-3080

 
## 炼制

炼丹主要分为以下4个步骤：
1. 准备炼制材料:即用于训练模型的素材。
2. 准备炼丹炉:即用于训练模型的环境。
3. 炼制丹药:即训练模型。
4. 收丹&试丹&评丹:即测试训练出来的模型。

### 0. 准备炼制材料(训练素材)

在这个阶段，我们要准备好用于炼丹的材料和各种药材(训练的素材)，并对材料进行处理(图像预处理)和提纯(提示词优化);其主要分为以下步骤：
1. 材料准备:即用于训练的训练素材准备。
2. 材料处理:即对用于训练图像进行预处理。
3. 材料提纯:即对用于训练图像的提示词进行优化。

#### 0. 材料准备(训练素材准备)
在开始炼制之前，我们首先要明确我们要炼制的丹药类型(Lora类型)，比如：易容丹(人像)，换装丹(衣服)，或者乾坤丹(画风)等。

明确好我们要炼制的丹药类型后，我们就可以根据我们需要的丹药类型进行药材收集(训练图像)。

下面我就以易容丹为例子，为大家介绍如何炼丹。

假定我们要炼制一炉易容成**漩涡·鸣人**的易容丹。我们需要收集对应的药材，药材越好，炼制出来的丹药一般越好。我们最好收集：
+ 15份以上的上年份药材(高质量图片:清晰度高，特征明显，非像素高)，20份以上最佳。
+ 药材各位部位齐全(人像的各个角度，各种情绪)，最好有几份完整的药材(人物的全身照)。
+ 药材各部位尽量不要重复(减少重复或相似度高的图片)。

药材准备完毕后，我们需要使用工具对药材做规格统一处理(统一图片尺寸)，规格越大，对丹火(显卡)的要求越高，过大的规格可能会让丹火无法融化药材从而导致炸炉：
+ 对于规格较小的药材，我们可以使用SD的高清修复扩展,修复为我们需要的规格，或者直接设置规格(直接重设分辨率:不推荐)。
+ 对于规格较大的药材，我们可以选取主体部分进行裁剪。
+ 需要主要的是，无论药材规格是大是小，一定要是64的倍数。

在这里，我准备的是15份规格为512*512的药材用于炼制。

#### 1. 材料处理(图像预处理)

这一步，我们需要对准备好的药材，进一步进行处理，这步处理，主要在于，对药材的成分进行分析并记录(对训练素材打标签)。

当前市场上面，已经有很多对的药材分析工具了(提示词反推)，我这里简要介绍几种：

**1. SD图像预处理**

1. 将准备好的药材，上传到上传到SD服务的实例中。(/root/onethingai-tmp/tarin/naruto_in)
2. 打开SD，进入到训练-图像预处理页面。
3. 在资源目录下输入我们放置药材的位置。(/root/onethingai-tmp/tarin/naruto_in)
4. 在目标目录下输入我们期望药材处理后放置的位置。(/root/onethingai-tmp/tarin/naruto_out)
5. 勾选生成 DeepBooru,如果训练素材不够，可以勾选水平反转，这样可以是的我们的药材翻倍。
6. 点击预处理图像

**2. Tagger处理**
1. 安装 [Tagger](https://github.com/toriato/stable-diffusion-webui-wd14-tagger) 插件 
2. 将准备好的药材，上传到上传到SD服务的实例中。(/root/onethingai-tmp/tarin/naruto_in)
3. 打开Tagger-从目录批量处理页面。
4. 在输入目录下输入我们放置药材的位置。(/root/onethingai-tmp/tarin/naruto_in)
5. 在输出目录下输入我们期望药材处理后放置的位置。(/root/onethingai-tmp/tarin/naruto_out)
6. 调整药材分析层度的阈值。
7. 点击反向推导

#### 2. 材料提纯(提示词优化)

上一步中，我们借助工具完成了对药材的分析(对训练素材打标签)，但是毕竟是工具分析的，存在一定误差，我们可以根据自己的需要调整一下，其优缺点如下:

**1. 不调整**
+ 优点:省事
+ 缺点:
  1. 炼丹失败概率增加(训练失败)
  2. 炼丹结果不确定(训练出的模型，风格多样)
  3. 炼丹时常增加(训练轮次epoch增加)

**2. 不调整**
+ 优点:
  1. 丹药更符合需求(画风明确，还原特征能力更强)
  2. 使用更加方便(可以设置触发词，使用更方便)
+ 缺点:
  1. 费事
  2. 过度调整可能导致药性过强，不能轻易服用(过度拟合，泛化能力弱)

**注意**

我们在调整提示词时，如果需要将保留对于的特征则需要删除对应的提示词，如漩涡鸣人的特点是黄头发，我们就需要删除yellow hair这个提示词。

我们需要以什么提示词作为触发词，则需要加入这个提示词，如，我们现在炼制的是鸣人的易容丹，我们则可以，在提示词前面加入 **naruto** 作为触发词。

### 1. 丹炉准备(训练环境参数配置)

在这个环节，主要是准备好我们炼丹需要的炼丹炉，然后调节好炼丹需要的火候。

#### 0.炼丹炉准备(训练环境准备)

炼丹炉的选择有多样，我们可以选择自己打造炼丹炉，也可以选择别人打造好的炼丹炉。

在这里，我使用别人打造好的炼丹炉。如果你想打造自己的炼丹炉，可以参考上一个章节。

+ 丹室 (使用平台) [OnethingAI](https://onethingai.com/)
+ 丹炉 (使用镜像) Ubuntu(22.04)/SD-LoRA训练-炼丹炉LoRA-scripts:v0.1.2
+ 丹火 (使用显卡) NVIDIA-GEFORCE-RTX-3080

选择好丹炉后，我们就可以生火开炉了(实例开机)

#### 1.炼丹炉火候调节(训练参数配置)

与古法炼丹需要炼丹师实时调整火候不同，现在炼丹讲究身与心合，心与炉合，意念融入丹炉，为丹炉打上思想钢印(训练参数配置),就可以让丹炉自动炼制了。

首先，我们点的工作台实例右侧工具栏丹炉按钮，打开丹炉配置界面。

我们这次使用新手配置，可以帮助我们省去许多复杂流程。

##### 0.配置底模

在训练用模型这里，我们选择底模为 ./sd-models/mjxs.safetensors

但你需要注意，这个模型你的丹炉可能没有，我们需要去下载下来，放到对应的文件夹下。

0.打开JupyterLab

1.打开终端

2.切换文件夹

```bash
cd /root/onethingai-tmp/app/sd-trainer/sd-models
```

3.下载模型
```bash
curl -o mjxs.safetensors https://liblibai-online.vibrou.com/web/model/7c819b6d13663ed720c2254f4fe18373107dfef2448d337913c8fc545640881e.safetensors?attname=majicMIX%20realistic%20%E9%BA%A6%E6%A9%98%E5%86%99%E5%AE%9E_v7.safetensors
```

##### 1.配置药材(数据集)

0.打开JupyterLab

1.通过左侧目录栏切换文件夹到 /root/onethingai-tmp/app/sd-trainer

2.新建并进入文件夹 train

3.新建并进入放置数据集的文件夹 naruto

4.新建一个数字开头的文件夹，其格式为:数字_特征，数字表示图片训练的重复次数，特征即是模型的特征。这里我们将文件夹命名为 30_naruto,因为我们图片较少，我们让它多炼制几次。

5.将我们准备好的用于炼制的药材(图片即tag)放到丹炉中(上传到 30_naruto 文件夹下)

6.在配置界面(Lora训练-新手-数据集设置-train_data_dir)填入路径: /train/naruto

##### 2.配置出丹位置(模型保存位置)

在配置界面(Lora训练-新手-保存设置-output_name)填入名称: naruto

##### 3.其他参数：维持默认不变

注意修改丹药规格(Lora训练-新手-数据集设置-resolution)，因为我们这里规格和默认相同，所以不需要修改，如果不同，请改成和你的相同即可。

炼丹轮次(Lora训练-新手-训练相关参数)与炼丹经验(Lora训练-新手-学习率与优化器设置)如果有一定了解，可以自己进行适当调整，如果没有，维持不变。

其他维持比变

### 2. 炼制(训练)

0.开始之前，你需要为你的丹炉开启魔法，他需要一些外界资源。

```bash
export https_proxy=http://172.17.0.1:1080
```

1.点击炼丹界面右侧工具栏下部开始训练按钮，就会开始训练。

2.等待炼丹完成。

### 3. 收丹&试丹&评丹(模型测试)

炼制完成的丹药(训练完成的模型),我们可以通过一下方式获取到：
0.打开JupyterLab

1.通过左侧目录栏切换文件夹到 /root/onethingai-tmp/app/sd-trainer/output

2.你可以在里面找到名字为 naruto.safetensors 易容丹，把它下载下来，放到SD里，让我们施法检测一下。

3.也可以通过查看炼制(训练)数据，查看丹药情况。不拟合或者过拟合，丹药品质都不好，算是废丹。但废丹有时候也能起到奇效，看怎么使用。

4.成丹我们将其放到SD里进行实际使用检测，看起品质，一般情况下，丹成九品，1-3等为下品，4-6等为中品，7-9等为上品；除此之外，9品之上为极品，极品之上则为超品。

#### 测试

0. 上传炼制好的易容丹到 stable-diffusion-webui/models/Lora 目录。
1. 打开 SD，在 SD 模型里先加载模型训练时的底模，LoRA 模型里使用刚刚炼制好的丹药(LoRA 模型)，如 naruto001.safetensors 模型，填上一些必要的提示词和参数。
3. **把引入的 LoRA 模型提示词，改成变量模式，如： 改成 ，NUM 变量代表模型序号，STRENGTH 变量代表权重值**
4. 在 Stable Diffusion WebUI 页面最底部的脚本栏中调用 XYZ plot 脚本，设置模型对比参数。
>划重点：其中 X 轴类型和 Y 轴类型都选择「提示词搜索/替换」Prompt S/R。
> 
>X 轴值输入：NUM,000001,000002,000003,000004,000005，对应模型序号
>
>Y 轴值输入：STRENGTH,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1，对应模型权重值
5. 设置完毕后，点击「生成」，开始生成模型测试对比图。
6. 通过对比生成结果，选出表现最佳的模型和权重值。(主观判断)

通过上面的步骤，我们就得到了我们需要的好丹(Lora模型)与使用方式(模型权重)。

